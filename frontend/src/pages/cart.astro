---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import PaymentModal from '../components/solana/PaymentModal.astro';

// Sample cart data - in a real app, this would come from state management or API
const cartItems = [
  {
    id: 1,
    title: "Vintage Camera Collection",
    description: "Rare vintage cameras from the 1960s",
    price: 299.99,
    originalPrice: 399.99,
    image: "https://via.placeholder.com/150x150/E60012/FFFFFF?text=Product+1",
    quantity: 1,
    seller: "CameraExpert",
    condition: "Used"
  },
  {
    id: 2,
    title: "Wireless Headphones",
    description: "Premium noise-canceling headphones",
    price: 199.99,
    image: "https://via.placeholder.com/150x150/0066CC/FFFFFF?text=Product+2",
    quantity: 2,
    seller: "TechStore",
    condition: "New"
  }
];

const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
const shipping = 9.99;
const tax = subtotal * 0.08;
const total = subtotal + shipping + tax;
---

<Layout title="Shopping Cart - Soladia">
  <Navigation />
  
  <div class="cart-container">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
      <h1 class="page-title mobile-text-2xl sm:mobile-text-3xl lg:mobile-text-4xl">
        Shopping Cart
      </h1>
      
      {cartItems.length > 0 ? (
        <div class="cart-content mobile-flex lg:flex-row gap-6 lg:gap-8">
          <!-- Cart Items -->
          <div class="cart-items lg:flex-1">
            {cartItems.map((item) => (
              <div class="cart-item mobile-card" data-item-id={item.id}>
                <div class="item-image">
                  <img src={item.image} alt={item.title} class="mobile-img" />
                </div>
                <div class="item-details flex-1">
                  <h3 class="item-title mobile-text-base sm:mobile-text-lg">{item.title}</h3>
                  <p class="item-description mobile-text-sm sm:mobile-text-base">{item.description}</p>
                  <div class="item-meta mobile-text-xs sm:mobile-text-sm">
                    <span class="item-seller">Sold by: {item.seller}</span>
                    <span class="item-condition">Condition: {item.condition}</span>
                  </div>
                </div>
                <div class="item-quantity mobile-flex sm:flex-col gap-2">
                  <label for={`quantity-${item.id}`} class="mobile-text-xs sm:mobile-text-sm">Qty:</label>
                  <select id={`quantity-${item.id}`} class="quantity-select mobile-form" data-item-id={item.id}>
                    {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map((qty) => (
                      <option value={qty} selected={qty === item.quantity}>{qty}</option>
                    ))}
                  </select>
                </div>
                <div class="item-price text-right">
                  <div class="price-current mobile-text-lg sm:mobile-text-xl">${item.price.toFixed(2)}</div>
                  {item.originalPrice && (
                    <div class="price-original mobile-text-sm sm:mobile-text-base">${item.originalPrice.toFixed(2)}</div>
                  )}
                </div>
                <div class="item-total mobile-text-lg sm:mobile-text-xl font-bold">
                  ${(item.price * item.quantity).toFixed(2)}
                </div>
                <button class="remove-item touch-target" data-item-id={item.id}>
                  <span class="remove-icon">üóëÔ∏è</span>
                </button>
              </div>
            ))}
          </div>

          <!-- Order Summary -->
          <div class="order-summary mobile-card lg:w-80">
            <h3 class="summary-title mobile-text-lg sm:mobile-text-xl">Order Summary</h3>
            <div class="summary-line mobile-text-sm sm:mobile-text-base">
              <span>Subtotal ({cartItems.length} items)</span>
              <span>${subtotal.toFixed(2)}</span>
            </div>
            <div class="summary-line mobile-text-sm sm:mobile-text-base">
              <span>Shipping</span>
              <span>${shipping.toFixed(2)}</span>
            </div>
            <div class="summary-line mobile-text-sm sm:mobile-text-base">
              <span>Tax</span>
              <span>${tax.toFixed(2)}</span>
            </div>
            <div class="summary-line summary-total mobile-text-base sm:mobile-text-lg">
              <span>Total</span>
              <span>${total.toFixed(2)}</span>
            </div>
            
            <!-- Solana Payment Options -->
            <div class="payment-options">
              <h4 class="payment-title mobile-text-base sm:mobile-text-lg">Payment Options</h4>
              <div class="payment-methods mobile-space-y">
                <button class="payment-method active mobile-btn" data-method="sol">
                  <span class="method-icon">‚òÄÔ∏è</span>
                  <div class="flex flex-col">
                    <span class="method-name mobile-text-sm sm:mobile-text-base">Pay with SOL</span>
                    <span class="method-amount mobile-text-xs sm:mobile-text-sm">{(total / 100).toFixed(4)} SOL</span>
                  </div>
                </button>
                <button class="payment-method mobile-btn" data-method="usdc">
                  <span class="method-icon">üíµ</span>
                  <div class="flex flex-col">
                    <span class="method-name mobile-text-sm sm:mobile-text-base">Pay with USDC</span>
                    <span class="method-amount mobile-text-xs sm:mobile-text-sm">{total.toFixed(2)} USDC</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- Checkout Button -->
            <button class="checkout-btn mobile-btn" id="checkout-btn">
              <span class="checkout-icon">üõí</span>
              <span class="mobile-only">Checkout</span>
              <span class="mobile-hidden">Proceed to Checkout</span>
            </button>
          </div>
        </div>
      ) : (
        <div class="empty-cart text-center py-12 sm:py-16">
          <div class="empty-icon text-6xl sm:text-8xl mb-4">üõí</div>
          <h2 class="empty-title mobile-text-xl sm:mobile-text-2xl mb-2">Your cart is empty</h2>
          <p class="empty-description mobile-text-base sm:mobile-text-lg mb-6">Add some items to get started!</p>
          <a href="/" class="btn-primary mobile-btn sm:w-auto">Continue Shopping</a>
        </div>
      )}
    </div>
  </div>

  <!-- Payment Modal -->
  <PaymentModal />
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Quantity change handler
    const quantitySelects = document.querySelectorAll('.quantity-select');
    quantitySelects.forEach(select => {
      select.addEventListener('change', function(this: HTMLSelectElement) {
        const itemId = this.getAttribute('data-item-id');
        const newQuantity = parseInt(this.value);
        if (itemId) {
          updateItemQuantity(itemId, newQuantity);
        }
      });
    });

    // Remove item handler
    const removeButtons = document.querySelectorAll('.remove-item');
    removeButtons.forEach(button => {
      button.addEventListener('click', function(this: HTMLElement) {
        const itemId = this.getAttribute('data-item-id');
        if (itemId) {
          removeItem(itemId);
        }
      });
    });

    // Payment method selection
    const paymentMethods = document.querySelectorAll('.payment-method');
    paymentMethods.forEach(method => {
      method.addEventListener('click', function(this: HTMLElement) {
        paymentMethods.forEach(m => m.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Checkout button
    const checkoutBtn = document.getElementById('checkout-btn');
    if (checkoutBtn) {
      checkoutBtn.addEventListener('click', () => {
        const selectedMethod = document.querySelector('.payment-method.active');
        const method = selectedMethod?.getAttribute('data-method') || 'sol';
        initiateCheckout(method);
      });
    }
  });

  function updateItemQuantity(itemId: string, quantity: number) {
    // In a real app, this would update the cart state and recalculate totals
    console.log(`Updating item ${itemId} quantity to ${quantity}`);
    // For now, just show a notification
    showNotification('Quantity updated', 'success');
  }

  function removeItem(itemId: string) {
    // In a real app, this would remove the item from cart state
    const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
    if (itemElement) {
      itemElement.remove();
      showNotification('Item removed from cart', 'info');
    }
  }

  function initiateCheckout(method: string) {
    // In a real app, this would open the payment modal or redirect to checkout
    console.log(`Initiating checkout with ${method}`);
    
    // Show payment modal
    const paymentModal = document.getElementById('payment-modal');
    if (paymentModal) {
      paymentModal.classList.add('active');
    }
  }

  function showNotification(message: string, type: 'success' | 'error' | 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
</script>

<style>
  .cart-container {
    @apply min-h-screen bg-gray-50;
  }

  .page-title {
    @apply font-bold text-gray-900 mb-6 sm:mb-8;
  }

  .cart-content {
    @apply flex flex-col lg:flex-row gap-6 lg:gap-8;
  }

  .cart-items {
    @apply lg:flex-1 space-y-4;
  }

  .cart-item {
    @apply bg-white rounded-lg shadow-sm p-4 sm:p-6 flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-4;
  }

  .item-image {
    @apply w-full sm:w-20 h-20 object-cover rounded-lg;
  }

  .item-image img {
    @apply w-full h-full object-cover rounded-lg;
  }

  .item-details {
    @apply flex-1 w-full sm:w-auto;
  }

  .item-title {
    @apply font-semibold text-gray-900 mb-1;
  }

  .item-description {
    @apply text-gray-600 mb-2;
  }

  .item-meta {
    @apply flex flex-col sm:flex-row sm:space-x-4 space-y-1 sm:space-y-0;
  }

  .item-quantity {
    @apply flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-2;
  }

  .quantity-select {
    @apply border border-gray-300 rounded px-2 py-1 w-full sm:w-auto;
  }

  .item-price {
    @apply text-right w-full sm:w-auto;
  }

  .price-current {
    @apply font-semibold text-gray-900;
  }

  .price-original {
    @apply text-gray-500 line-through;
  }

  .item-total {
    @apply font-bold text-gray-900 w-full sm:w-auto text-center sm:text-right;
  }

  .remove-item {
    @apply p-2 text-gray-400 hover:text-red-500 transition-colors w-full sm:w-auto text-center;
  }

  .order-summary {
    @apply bg-white rounded-lg shadow-sm p-4 sm:p-6 h-fit;
  }

  .summary-title {
    @apply font-semibold text-gray-900 mb-4;
  }

  .summary-line {
    @apply flex justify-between py-2 border-b border-gray-200;
  }

  .summary-total {
    @apply font-bold text-gray-900 border-b-0 pt-2;
  }

  .payment-options {
    @apply mt-6;
  }

  .payment-title {
    @apply font-semibold text-gray-900 mb-3;
  }

  .payment-methods {
    @apply space-y-2;
  }

  .payment-method {
    @apply w-full p-3 border border-gray-300 rounded-lg flex items-center justify-between hover:bg-gray-50 transition-colors;
  }

  .payment-method.active {
    @apply border-blue-500 bg-blue-50;
  }

  .method-icon {
    @apply text-xl;
  }

  .method-name {
    @apply font-medium;
  }

  .method-amount {
    @apply text-gray-600;
  }

  .checkout-btn {
    @apply w-full mt-6 bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2;
  }

  .checkout-icon {
    @apply text-lg;
  }

  .empty-cart {
    @apply text-center py-12 sm:py-16;
  }

  .empty-icon {
    @apply mb-4;
  }

  .empty-title {
    @apply font-bold text-gray-900 mb-2;
  }

  .empty-description {
    @apply text-gray-600 mb-6;
  }

  .btn-primary {
    @apply bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors;
  }

  .notification {
    @apply fixed top-4 right-4 px-4 py-2 rounded-lg text-white font-medium z-50;
  }

  .notification-success {
    @apply bg-green-600;
  }

  .notification-error {
    @apply bg-red-600;
  }

  .notification-info {
    @apply bg-blue-600;
  }

  /* Mobile-specific cart item layout */
  @media (max-width: 640px) {
    .cart-item {
      @apply flex-col items-stretch;
    }
    
    .item-image {
      @apply w-full h-32;
    }
    
    .item-details {
      @apply w-full;
    }
    
    .item-quantity {
      @apply flex-row items-center justify-between;
    }
    
    .quantity-select {
      @apply w-20;
    }
    
    .item-price {
      @apply text-left;
    }
    
    .item-total {
      @apply text-left;
    }
    
    .remove-item {
      @apply w-full text-center py-2 border border-red-300 rounded hover:bg-red-50;
    }
  }

  /* Mobile payment method layout */
  @media (max-width: 640px) {
    .payment-method {
      @apply flex-col items-start space-y-2;
    }
    
    .method-icon {
      @apply text-2xl;
    }
  }
</style>
